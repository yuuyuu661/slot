<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #111;
      color: #fff;
      overflow-x: hidden;
    }
    .slot-container {
      display: flex;
      justify-content: center;
      margin-top: 50px;
      overflow: hidden;
      width: 650px;
      height: 400px;
      position: relative;
      margin-left: auto;
      margin-right: auto;
    }
    .reel-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 2px;
    }
    .reel {
      width: 100px;
      height: 400px;
      overflow: hidden;
      background: #222;
      border: 3px solid #fff;
      position: relative;
    }
    .symbols {
      position: absolute;
      top: 0;
      width: 100%;
    }
    .symbol {
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }
    .symbol.highlight {
      border: 2px solid yellow;
      background-color: rgba(255, 255, 0, 0.2);
      border-radius: 8px;
    }
    .stop-btn {
      margin-top: 5px;
      font-size: 16px;
      padding: 5px 10px;
    }
    #start {
      margin-top: 30px;
      font-size: 24px;
      padding: 10px 20px;
    }
    #coinDisplay {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
<audio id="win3" src="sounds/win3.mp3" preload="auto"></audio>
<audio id="win4" src="sounds/win4.mp3" preload="auto"></audio>
<audio id="win5" src="sounds/win5.mp3" preload="auto"></audio>
<audio id="loseSound" src="sounds/lose.mp3" preload="auto"></audio>
  <h1>üé∞ „Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥ üé∞</h1>
  <div class="slot-container" id="slotContainer">
    <!-- 5 reels -->
    <script>
      for (let i = 0; i < 5; i++) {
        document.write(`
          <div class="reel-wrapper">
            <div class="reel"><div class="symbols"></div></div>
            <button class="stop-btn" data-index="${i}">STOP</button>
          </div>
        `);
      }
    </script>
  </div>

  <button id="start">„Çπ„Çø„Éº„ÉàÔºÅ</button>
  <div id="coinDisplay">ÊâÄÊåÅ„Ç≥„Ç§„É≥: <span id="coins">100</span></div>
  <div id="result"></div>

  <script>
    const symbols = [
      { name: "slime", src: "images/slime.png" },
      { name: "lemon", src: "images/lemon.png" },
      { name: "grape", src: "images/grape.png" },
      { name: "bell", src: "images/bell.png" },
      { name: "gem", src: "images/gem.png" },
    ];
    const symbolWeights = [40, 25, 15, 10, 10];

    const reels = document.querySelectorAll('.reel');
    const coinsEl = document.getElementById("coins");
    const resultEl = document.getElementById("result");
    const startBtn = document.getElementById("start");
    let coins = 100;
    let spinningFlags = [];

    function getRandomSymbol() {
      const total = symbolWeights.reduce((a, b) => a + b, 0);
      const rand = Math.random() * total;
      let cumulative = 0;
      for (let i = 0; i < symbols.length; i++) {
        cumulative += symbolWeights[i];
        if (rand < cumulative) return symbols[i];
      }
      return symbols[symbols.length - 1];
    }

    function createSymbolDiv(symbol) {
      const div = document.createElement("div");
      div.className = "symbol";
      const img = document.createElement("img");
      img.src = symbol.src;
      img.alt = symbol.name;
      img.style.width = "80px";
      img.style.height = "80px";
      div.appendChild(img);
      return div;
    }

    function setupReels() {
      reels.forEach(reel => {
        const container = reel.querySelector('.symbols');
        container.innerHTML = '';
        for (let i = 0; i < 20; i++) {
          container.appendChild(createSymbolDiv(getRandomSymbol()));
        }
        container.style.top = "0px";
      });
      document.querySelectorAll(".symbol").forEach(el => el.classList.remove("highlight"));
    }

    function startReel(index) {
      const container = reels[index].querySelector('.symbols');
      let pos = 0;
      let speed = 20;
      let slowing = false;

      function animate() {
        pos += speed;
        if (pos >= 100) {
          container.appendChild(createSymbolDiv(getRandomSymbol()));
          container.removeChild(container.firstElementChild);
          pos -= 100;
        }
        container.style.top = -pos + "px";

        if (!spinningFlags[index]) {
          if (!slowing) slowing = true;
          speed *= 0.92;
          if (speed <= 1) {
            const aligned = Math.round(pos / 100) * 100;
            container.style.top = -aligned + "px";
            return;
          }
        }
        requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }

    function startSpinning() {
      spinningFlags = [true, true, true, true, true];
      for (let i = 0; i < reels.length; i++) startReel(i);
    }

    function stopReel(index) {
      spinningFlags[index] = false;
      if (spinningFlags.every(flag => !flag)) setTimeout(checkWinLines, 600);
    }

    function getVisibleSymbols() {
      const visible = [[], [], []];
      reels.forEach((reel, col) => {
        const container = reel.querySelector('.symbols');
        const top = parseFloat(container.style.top) || 0;
        const offset = Math.round(-top / 100);
        const symbols = container.children;
        for (let row = 0; row < 3; row++) {
          const el = symbols[offset + row];
          visible[row][col] = el?.querySelector("img")?.alt || '';
        }
      });
      return visible;
    }

    function getSymbolElement(row, col) {
      const container = reels[col].querySelector('.symbols');
      const top = parseFloat(container.style.top) || 0;
      const offset = Math.round(-top / 100);
      return container.children[offset + row];
    }

    function checkWinLines() {
  const visible = getVisibleSymbols();
  const results = [];
  const highlightMap = [];

  visible.forEach((line, rowIndex) => {
    for (let start = 0; start <= 2; start++) {
      const symbol = line[start];
      let count = 1;
      for (let i = start + 1; i < 5 && line[i] === symbol; i++) count++;
      if (count >= 3) {
        results.push({ row: rowIndex, start, length: count, symbol });
        for (let i = start; i < start + count; i++) {
          highlightMap.push({ row: rowIndex, col: i });
        }
        break; // 1Âàó1ÂΩì„Åü„Çä„Åæ„ÅßÂà§ÂÆöÔºàÂøÖË¶Å„Å™„ÇâÂâäÈô§ÂèØÔºâ
      }
    }
  });

  // „Éè„Ç§„É©„Ç§„Éà
  highlightMap.forEach(({ row, col }) => {
    const el = getSymbolElement(row, col);
    if (el) el.classList.add("highlight");
  });

  // ÂäπÊûúÈü≥„Å®ÁµêÊûúË°®Á§∫
  const win3 = document.getElementById("win3");
  const win4 = document.getElementById("win4");
  const win5 = document.getElementById("win5");
  const loseSound = document.getElementById("loseSound");

  if (results.length > 0) {
    const maxLength = Math.max(...results.map(r => r.length));
    if (maxLength === 5) {
      win5.play();
    } else if (maxLength === 4) {
      win4.play();
    } else {
      win3.play();
    }

    let message = "ÂΩì„Åü„ÇäÔºÅ‚Üí ";
    message += results.map(r =>
      `„Äå${['‰∏ä', '‰∏≠', '‰∏ã'][r.row]}ÊÆµÔºö${r.symbol}Ôºà${r.length}ÂÄãÔºâ„Äç`
    ).join(' / ');
    resultEl.textContent = message;
    coins += 50 * results.length;
    coinsEl.textContent = coins;
  } else {
    loseSound.play();
    resultEl.textContent = "„Éè„Ç∫„É¨...";
  }

  // üëá„Éè„Ç§„É©„Ç§„Éà‰ªò‰∏é
  highlightMap.forEach(pos => {
    const el = getSymbolElement(pos.row, pos.col);
    if (el) el.classList.add("highlight");
  });
}

    document.querySelectorAll('.stop-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const index = parseInt(btn.getAttribute('data-index'));
        stopReel(index);
      });
    });

    startBtn.addEventListener("click", () => {
      if (spinningFlags.some(flag => flag)) return;
      if (coins <= 0) {
        resultEl.textContent = "„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ";
        return;
      }
      coins -= 10;
      coinsEl.textContent = coins;
      resultEl.textContent = "";
      setupReels();
      startSpinning();
    });
   const winSound = document.getElementById("winSound");
   const loseSound = document.getElementById("loseSound");

    setupReels();
  </script>
</body>
</html>
