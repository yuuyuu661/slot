<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スロットゲーム</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 2em;
    }
    h1 {
      color: #444;
    }
    #slotArea {
      margin: 2em auto;
      padding: 1em;
      background: white;
      border-radius: 8px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      margin: 0.5em;
      padding: 0.7em 1.2em;
      font-size: 1em;
    }
    #status {
      margin-top: 1em;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>🎰 スロットゲーム</h1>

  <div id="slotArea">
    <p>所持コイン: <span id="coinCount">-</span> Spt</p>
    <button id="startBtn">スタート</button>
    <button id="cashoutBtn">清算</button>
    <div id="status"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');
    const coinCountSpan = document.getElementById('coinCount');
    const statusDiv = document.getElementById('status');

    let coins = 0;

    // セッション情報取得
    async function fetchSession() {
      if (!sessionId) {
        statusDiv.textContent = "❌ セッションIDが見つかりません";
        return;
      }

      try {
        const res = await fetch(`/api/session?session=${sessionId}`);
        const data = await res.json();

        if (data.error) {
          statusDiv.textContent = `❌ ${data.error}`;
        } else {
          coins = data.coins;
          coinCountSpan.textContent = coins;
        }
      } catch (e) {
        statusDiv.textContent = "❌ セッション取得エラー";
      }
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      alert("🎰 スロットを回した！（仮）");
      // 実装次第でここでコインを減らすことも可能
    });

    document.getElementById('cashoutBtn').addEventListener('click', async () => {
      if (!sessionId) {
        alert("❌ セッションIDがありません");
        return;
      }

      try {
        const res = await fetch('/api/cashout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session: sessionId,
            coins: coins
          })
        });

        const data = await res.json();

        if (data.status === "ok") {
          statusDiv.textContent = `✅ 清算リクエストを送信しました`;
        } else {
          statusDiv.textContent = `❌ 清算失敗: ${data.error}`;
        }
      } catch (e) {
        statusDiv.textContent = "❌ 清算中に通信エラー";
      }
    });

    fetchSession();
  </script>
</body>
</html>
